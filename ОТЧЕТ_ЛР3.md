# ОТЧЕТ ПО ЛАБОРАТОРНОЙ РАБОТЕ №3
## Практическое знакомство с утилитой GNU Make

**Студент:** [ФИО]
**Группа:** [Номер группы]
**Дата:** 08.12.2025

---

## 1. ЦЕЛЬ РАБОТЫ

Изучить процесс компиляции программ на языке C (C++) в операционных системах Unix и приобрести практические навыки работы с утилитой GNU make для создания и сборки проектов.

---

## 2. ВЫПОЛНЕНИЕ ЗАДАНИЯ

### 2.1. ОСНОВНОЕ ЗАДАНИЕ (пункты 3-5)

#### Создание make-файла

Создан продвинутый Makefile для автоматизации сборки проекта, включающего:
- Код на языке C (`main.c`)
- Код на ассемблере в двух синтаксисах (`rotate.asm` - Intel, `rotate_att.s` - AT&T)

**Структура проекта:**
```
lab_1/
├── Makefile         # Главный make-файл
├── src/             # Исходные файлы
│   ├── main.c
│   ├── rotate.asm
│   └── rotate_att.s
└── bin/             # Собранные файлы
    ├── matrix_rotate  # Исполняемый файл
    └── obj/           # Объектные файлы и зависимости
```

#### Компиляция и выполнение

**Команда для сборки:**
```bash
make
```

**Вывод:**
```
==> Compiling C: src/main.c
gcc -Wall -m32 -DINPUT_CONSOLE -MD -c src/main.c -o bin/obj/main.o
    Object: bin/obj/main.o
==> Assembling (Intel): src/rotate.asm
nasm -f elf32 src/rotate.asm -o bin/obj/rotate.o
    Object: bin/obj/rotate.o
==> Linking: bin/matrix_rotate
gcc -Wall -m32 -DINPUT_CONSOLE bin/obj/main.o bin/obj/rotate.o -o bin/matrix_rotate
==> Build complete: bin/matrix_rotate
    Syntax: intel
    Input method: console
    Debug: no
```

**Запуск программы:**
```bash
make run
```

**Результат:**
```
=== Поворот матрицы 3x3 ===
Диапазон значений: [0, 10]

Исходная матрица:
       2        7       10
       8        9        3
       6        2        3

Матрица после поворота:
       6        8        2
       2        9        7
       3        3       10
```

✅ **Программа компилируется и работает корректно.**

#### Демонстрация инкрементальной сборки

**Шаг 1:** Проверка времени модификации файлов после первой сборки
```bash
$ stat -c "%y %n" bin/obj/*.o bin/matrix_rotate
2025-12-08 16:43:47.377522621 +0300 bin/obj/main.o
2025-12-08 16:43:47.386521824 +0300 bin/obj/rotate.o
2025-12-08 16:43:47.419056720 +0300 bin/matrix_rotate
```

**Шаг 2:** Изменение одного исходного файла
```bash
$ touch src/main.c
```

**Шаг 3:** Повторная сборка
```bash
$ make
==> Compiling C: src/main.c
gcc -Wall -m32 -DINPUT_CONSOLE -MD -c src/main.c -o bin/obj/main.o
    Object: bin/obj/main.o
==> Linking: bin/matrix_rotate
gcc -Wall -m32 -DINPUT_CONSOLE bin/obj/main.o bin/obj/rotate.o -o bin/matrix_rotate
==> Build complete: bin/matrix_rotate
```

**Шаг 4:** Проверка времени модификации после пересборки
```bash
$ stat -c "%y %n" bin/obj/*.o bin/matrix_rotate
2025-12-08 16:44:23.081047563 +0300 bin/obj/main.o     # ← ИЗМЕНИЛСЯ
2025-12-08 16:43:47.386521824 +0300 bin/obj/rotate.o   # ← НЕ ИЗМЕНИЛСЯ!
2025-12-08 16:44:23.102979145 +0300 bin/matrix_rotate  # ← ИЗМЕНИЛСЯ
```

**ВЫВОД:**
✅ При изменении одного файла (`main.c`):
- Перекомпилировался только `main.o`
- Файл `rotate.o` **НЕ** был перекомпилирован (время модификации не изменилось)
- Исполняемый файл был пересобран с новым `main.o`

✅ **Make правильно отслеживает зависимости и выполняет только необходимые команды компиляции.**

---

### 2.2. ДОПОЛНИТЕЛЬНОЕ ЗАДАНИЕ (пункт 6)

#### Создание make-файла с высоким уровнем автоматизации

✅ **Выполнены все требования:**

1. **Имена и параметры через переменные:**
```makefile
PROGRAM_NAME := matrix_rotate
SRC_DIR := src
BIN_DIR := bin
OBJ_DIR := $(BIN_DIR)/obj
COMPILE_FLAGS += -Wall -m32
```

2. **Динамическое формирование зависимостей:**
```makefile
# Автоматическое определение исходных файлов
C_SOURCES := $(wildcard $(SRC_DIR)/*.c)

# Формирование списка объектных файлов
C_OBJECTS := $(patsubst $(SRC_DIR)/%.c,$(OBJ_DIR)/%.o,$(C_SOURCES))

# Автоматическая генерация зависимостей
$(OBJ_DIR)/%.o: %.c | $(OBJ_DIR)
    $(CC) $(CFLAGS) -MD -c $< -o $@

# Включение файлов зависимостей
-include $(wildcard $(OBJ_DIR)/*.d)
```

3. **Цель clean:**
```makefile
clean:
    rm -f $(OBJ_DIR)/*.o $(OBJ_DIR)/*.d
```

4. **Структурирование проекта:**
```
src/     - исходные файлы
bin/     - скомпилированные файлы
bin/obj/ - объектные файлы и зависимости
```

**Демонстрация работы:**

```bash
# Просмотр конфигурации
$ make info
=== Build Configuration ===
Program name:   matrix_rotate
Target:         bin/matrix_rotate
Source dir:     src
Binary dir:     bin
Object dir:     bin/obj
...

# Сборка
$ make
==> Creating directory: bin/obj
==> Compiling C: src/main.c
==> Assembling (Intel): src/rotate.asm
==> Linking: bin/matrix_rotate
==> Build complete

# Очистка
$ make clean
==> Cleaning object files and dependencies...
==> Clean complete
```

---

### 2.3. ДОПОЛНИТЕЛЬНОЕ ЗАДАНИЕ (пункт 7)

#### Динамическое изменение функционального назначения программы

Реализованы следующие возможности управления через make:

#### 1. Выбор синтаксиса ассемблера

```bash
# Intel синтаксис (по умолчанию)
$ make SYNTAX=intel
==> Assembling (Intel): src/rotate.asm
nasm -f elf32 src/rotate.asm -o bin/obj/rotate.o

# AT&T синтаксис
$ make SYNTAX=att
==> Assembling (AT&T): src/rotate_att.s
as --32 src/rotate_att.s -o bin/obj/rotate_att.o
```

**Реализация:**
```makefile
SYNTAX ?= intel

ifeq ($(SYNTAX),att)
    ASM_SRC := rotate_att.s
    ASM_COMPILER := $(AS)
    ASM_FLAGS := $(ASFLAGS)
else
    ASM_SRC := rotate.asm
    ASM_COMPILER := $(ASM)
    ASM_FLAGS := $(ASMFLAGS)
endif
```

#### 2. Управление отладочными символами

```bash
# Обычная сборка
$ make DEBUG=no

# Сборка с отладочными символами
$ make DEBUG=yes
==> Compiling C: src/main.c
gcc -Wall -m32 -g -DDEBUG -DINPUT_CONSOLE -MD -c src/main.c ...
==> Assembling (Intel): src/rotate.asm
nasm -f elf32 -g -F dwarf src/rotate.asm ...
```

**Проверка:**
```bash
$ file bin/matrix_rotate
bin/matrix_rotate: ELF 32-bit ... with debug_info, not stripped
```

**Реализация:**
```makefile
DEBUG ?= no

ifeq ($(DEBUG),yes)
    CFLAGS += -g -DDEBUG
    ASMFLAGS += -g -F dwarf
endif
```

#### 3. Управление методом ввода данных

```bash
# Ввод из консоли (по умолчанию)
$ make INPUT_METHOD=console
# Добавляется флаг: -DINPUT_CONSOLE

# Чтение из файла
$ make INPUT_METHOD=file
# Добавляется флаг: -DINPUT_FILE

# Случайная генерация
$ make INPUT_METHOD=random
# Добавляется флаг: -DINPUT_RANDOM
```

**Реализация:**
```makefile
INPUT_METHOD ?= console

ifeq ($(INPUT_METHOD),file)
    CFLAGS += -DINPUT_FILE
else ifeq ($(INPUT_METHOD),random)
    CFLAGS += -DINPUT_RANDOM
else
    CFLAGS += -DINPUT_CONSOLE
endif
```

#### 4. Комбинированное использование

```bash
# Сборка с AT&T синтаксисом, отладкой и оптимизацией
$ make SYNTAX=att DEBUG=yes COMPILE_FLAGS="-O2"

==> Compiling C: src/main.c
gcc -O2 -Wall -m32 -g -DDEBUG -DINPUT_CONSOLE -MD -c src/main.c ...
==> Assembling (AT&T): src/rotate_att.s
as --32 src/rotate_att.s -o bin/obj/rotate_att.o
==> Linking: bin/matrix_rotate
...
==> Build complete: bin/matrix_rotate
    Syntax: att
    Input method: console
    Debug: yes
```

---

## 3. КЛЮЧЕВЫЕ ОСОБЕННОСТИ РЕАЛИЗАЦИИ

### 3.1. Используемые возможности GNU Make

#### Переменные и их переопределение
```makefile
# Базовое значение
COMPILE_FLAGS := -Wall -m32

# Переопределение с добавлением
override COMPILE_FLAGS += -pipe
```

#### Функции обработки строк
```makefile
# wildcard - поиск файлов
C_SOURCES := $(wildcard $(SRC_DIR)/*.c)

# patsubst - замена паттерна
C_OBJECTS := $(patsubst $(SRC_DIR)/%.c,$(OBJ_DIR)/%.o,$(C_SOURCES))

# basename - извлечение имени без расширения
ASM_OBJECT := $(OBJ_DIR)/$(basename $(ASM_SRC)).o
```

#### Автоматические переменные
```makefile
# $@ - имя цели
# $< - первая зависимость
# $^ - все зависимости

$(TARGET): $(OBJECTS)
    $(CC) $(CFLAGS) $^ -o $@
```

#### Шаблонные правила
```makefile
# Правило для всех .c файлов
%.o: %.c
    $(CC) $(CFLAGS) -c $< -o $@

# Правило для всех .asm файлов
%.o: %.asm
    $(ASM) $(ASMFLAGS) $< -o $@
```

#### Фиктивные цели
```makefile
.PHONY: all run test clean distclean rebuild info help
```

#### Order-only prerequisites
```makefile
# | $(OBJ_DIR) - директория должна существовать,
# но её время модификации не влияет на пересборку
$(OBJ_DIR)/%.o: %.c | $(OBJ_DIR)
    $(CC) $(CFLAGS) -c $< -o $@
```

### 3.2. Автоматическая генерация зависимостей

**Механизм:**
1. Флаг `-MD` создаёт файлы `.d` с зависимостями при компиляции
2. Директива `-include` подключает эти файлы в Makefile
3. Make автоматически отслеживает изменения в заголовочных файлах

**Пример файла зависимостей (`bin/obj/main.d`):**
```makefile
bin/obj/main.o: src/main.c /usr/include/stdio.h \
  /usr/include/stdlib.h /usr/include/stdint.h \
  /usr/include/time.h ...
```

---

## 4. ТЕСТИРОВАНИЕ

### Тест 1: Базовая функциональность
```bash
$ make test
Test 1: 3x3 matrix (0-10)
=== Поворот матрицы 3x3 ===
...

Test 2: 4x4 matrix (-50 to 50)
=== Поворот матрицы 4x4 ===
...

Test 3: 2x2 matrix (0-100)
=== Поворот матрицы 2x2 ===
...
```
✅ **Все тесты пройдены успешно**

### Тест 2: Инкрементальная сборка
✅ **Подтверждено:** только изменённые файлы перекомпилируются

### Тест 3: Динамическая компиляция
✅ **Подтверждено:** все параметры работают корректно

---

## 5. ВЫВОДЫ

В ходе лабораторной работы:

1. ✅ Изучен процесс компиляции программ на C и ассемблере в Unix
2. ✅ Получены практические навыки работы с GNU Make
3. ✅ Создан продвинутый Makefile с автоматическим определением зависимостей
4. ✅ Реализована инкрементальная сборка с отслеживанием изменений
5. ✅ Реализовано динамическое управление параметрами компиляции
6. ✅ Использованы все основные возможности make:
   - Переменные
   - Функции обработки строк
   - Автоматические переменные
   - Шаблонные правила
   - Фиктивные цели
   - Условная компиляция
   - Автоматическая генерация зависимостей

**Все требования задания выполнены в полном объёме.**

---

## 6. ПРИЛОЖЕНИЯ

### Файлы проекта:
- `Makefile` - главный файл сборки
- `LAB3_README.md` - подробная документация
- `DEMO.sh` - демонстрационный скрипт
- `src/main.c` - основной код на C
- `src/rotate.asm` - ассемблерная функция (Intel)
- `src/rotate_att.s` - ассемблерная функция (AT&T)

### Команды для проверки:
```bash
# Просмотр справки
make help

# Просмотр конфигурации
make info

# Сборка
make

# Запуск
make run

# Тесты
make test

# Демонстрация инкрементальной сборки
make clean && make && touch src/main.c && make

# Динамическая компиляция
make SYNTAX=att
make DEBUG=yes
make SYNTAX=att DEBUG=yes COMPILE_FLAGS="-O2"
```

---

**Дата сдачи:** 08.12.2025
**Подпись студента:** _______________
